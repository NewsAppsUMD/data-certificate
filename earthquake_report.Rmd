---
title: "Earthquake Analysis Report"
output: 
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(glue)
library(knitr)
```

## Summary

This report provides an automated analysis of recent earthquake activity based on data from the USGS.
```{r load-data, include=FALSE}
# Read the earthquake data
all_earthquakes <- read_csv("earthquakes.csv", show_col_types = FALSE)

# Define time periods
week_ago <- now() - weeks(1)
two_weeks_ago <- now() - weeks(2)

# Count earthquakes in each period
recent_week <- all_earthquakes |>
  filter(time >= week_ago & time < now()) |>
  nrow()

previous_week <- all_earthquakes |>
  filter(time >= two_weeks_ago & time < week_ago) |>
  nrow()

# Calculate percentage change
pct_change <- ((recent_week - previous_week) / previous_week) * 100

# Categorize earthquakes by intensity
earthquakes_categorized <- all_earthquakes |>
  filter(time >= (now() - months(1))) |>
  mutate(
    intensity = case_when(
      mag < 2.0 ~ "Micro",
      mag < 4.0 ~ "Minor",
      mag < 5.0 ~ "Light",
      mag < 6.0 ~ "Moderate",
      mag < 7.0 ~ "Strong",
      mag < 8.0 ~ "Major",
      mag >= 8.0 ~ "Great",
      TRUE ~ "Unknown"
    )
  )

# Count by category
intensity_counts <- earthquakes_categorized |>
  count(intensity, sort = TRUE) |>
  mutate(percentage = round(n / sum(n) * 100, 1))
```

## Weekly Trends

In the past week, there were **`r format(recent_week, big.mark = ",")`** earthquakes compared to **`r format(previous_week, big.mark = ",")`** the week before, a **`r abs(round(pct_change, 1))`%** `r if(pct_change > 0) "increase" else "decrease"`.

## Earthquake Distribution by Intensity (Past Month)

The following table shows the breakdown of earthquakes by intensity category over the past month:
```{r intensity-table}
intensity_counts |>
  mutate(
    n = format(n, big.mark = ","),
    percentage = paste0(percentage, "%")
  ) |>
  rename(
    Intensity = intensity,
    Count = n,
    Percentage = percentage
  ) |>
  kable(align = c("l", "r", "r"))
```

**Total earthquakes analyzed:** `r format(nrow(earthquakes_categorized), big.mark = ",")`

## Magnitude Distribution

The histogram below shows the distribution of earthquake magnitudes over the past month, color-coded by intensity category:
```{r histogram, fig.width=10, fig.height=6}
earthquakes_categorized |>
  ggplot(aes(x = mag, fill = intensity)) +
  geom_histogram(binwidth = 0.5, color = "white") +
  scale_fill_manual(
    values = c(
      "Micro" = "#E0F0E0",
      "Minor" = "#90EE90",
      "Light" = "#FFD700",
      "Moderate" = "#FFA500",
      "Strong" = "#FF6347",
      "Major" = "#DC143C",
      "Great" = "#8B0000",
      "Unknown" = "#808080"
    )
  ) +
  labs(
    title = "Earthquake Distribution by Magnitude (Past Month)",
    subtitle = glue::glue("Total earthquakes: {format(nrow(earthquakes_categorized), big.mark = ',')}"),
    x = "Magnitude",
    y = "Count",
    fill = "Intensity"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "right"
  )
```

## Recent Significant Events (Japan, Past 24 Hours)
```{r japan-quakes}
# Filter for Japan earthquakes in past 24 hours
filtered_earthquakes <- all_earthquakes |>
  filter(
    mag >= 5 &
      str_detect(place, "Japan") &
      time >= (now() - days(1))
  )

if (nrow(filtered_earthquakes) == 0) {
  cat("No earthquakes of magnitude 5 or greater were recorded near Japan in the past 24 hours.")
} else {
  earthquake_sentences <- filtered_earthquakes |>
    mutate(
      date = format(time, "%B %d, %Y"),
      time_formatted = format(time, "%H:%M:%S UTC")
    ) |>
    arrange(desc(time))
  
  for (i in 1:nrow(earthquake_sentences)) {
    cat(glue::glue("- At {earthquake_sentences$time_formatted[i]} on {earthquake_sentences$date[i]}, an earthquake of magnitude {earthquake_sentences$mag[i]} ({earthquake_sentences$magType[i]}) was recorded {earthquake_sentences$place[i]}.\n\n"))
  }
}
```

---

*Report generated automatically from USGS earthquake data. Data is updated daily.*

